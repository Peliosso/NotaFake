<?php
// CONFIGURA√á√ïES DO BOT
$token = "8362847658:AAHoF5LFmYDZdWPm9Umde9M5dqluhnpUl-g";
$apiURL = "https://api.telegram.org/bot$token/";
$cep_origem = "30140071"; // Belo Horizonte, MG

// PEGAR MENSAGENS
$update = json_decode(file_get_contents("php://input"), true);
// Permitir mensagens em grupos
if (isset($update["message"]["chat"]["type"]) && $update["message"]["chat"]["type"] != "private") {
    $message = $update["message"]["text"] ?? "";
    $chat_id = $update["message"]["chat"]["id"];
}
$chat_id = $update["message"]["chat"]["id"] ?? $update["callback_query"]["message"]["chat"]["id"];
$message = $update["message"]["text"] ?? null;
$callback_query = $update["callback_query"]["data"] ?? null;
$message_id = $update["callback_query"]["message"]["message_id"] ?? null;

// ARQUIVOS PARA SALVAR OS DADOS
$usuariosFile = "usuarios.json";
if (!file_exists($usuariosFile)) file_put_contents($usuariosFile, "{}");
$usuarios = json_decode(file_get_contents($usuariosFile), true);

$cuponsFile = "cupons.json";
if (!file_exists($cuponsFile)) file_put_contents($cuponsFile, "{}");
$cupons = json_decode(file_get_contents($cuponsFile), true);

$bloqueadosFile = "bloqueados.json";
if (!file_exists($bloqueadosFile)) file_put_contents($bloqueadosFile, "[]");
$bloqueados = json_decode(file_get_contents($bloqueadosFile), true);

// FUN√á√ÉO PARA ENVIAR MENSAGENS
function sendMessage($chat_id, $text, $reply_markup = null) {
    global $apiURL;
    $data = [
        "chat_id" => $chat_id,
        "text" => $text,
        "parse_mode" => "Markdown"
    ];
    if ($reply_markup) $data["reply_markup"] = json_encode($reply_markup);
    $response = file_get_contents($apiURL . "sendMessage?" . http_build_query($data));
    return json_decode($response, true)["result"]["message_id"] ?? null;
}

// FUN√á√ÉO PARA EDITAR MENSAGENS
function editMessage($chat_id, $message_id, $text, $reply_markup = null) {
    global $apiURL;
    $data = [
        "chat_id" => $chat_id,
        "message_id" => $message_id,
        "text" => $text,
        "parse_mode" => "Markdown"
    ];
    if ($reply_markup) $data["reply_markup"] = json_encode($reply_markup);
    file_get_contents($apiURL . "editMessageText?" . http_build_query($data));
}

// FUN√á√ÉO PARA CALCULAR FRETE
function calcularFrete($cep_destino, $peso = 1) {
    global $cep_origem;
    $url = "https://www2.correios.com.br/sistemas/precosPrazos/PrecoPrazo.asmx/CalcPrecoPrazo?" . http_build_query([
        "nCdEmpresa" => "",
        "sDsSenha" => "",
        "nCdServico" => "04510",
        "sCepOrigem" => $cep_origem,
        "sCepDestino" => $cep_destino,
        "nVlPeso" => $peso,
        "nCdFormato" => 1,
        "nVlComprimento" => 20,
        "nVlAltura" => 5,
        "nVlLargura" => 15,
        "nVlDiametro" => 0,
        "sCdMaoPropria" => "N",
        "nVlValorDeclarado" => 0,
        "sCdAvisoRecebimento" => "N"
    ]);

    $response = @file_get_contents($url);
    if ($response === false) return rand(30, 50);
    if (preg_match('/<Valor>(.*?)<\/Valor>/', $response, $matches)) {
        $valor = str_replace(",", ".", $matches[1]);
        return (float)$valor > 0 ? (float)$valor : rand(30, 50);
    }
    return rand(30, 50);
}

// --- MENU PRINCIPAL /start ---
if ($message == "/start") {
    $keyboard = [
        "inline_keyboard" => [
            [
                ["text" => "‚ö∞Ô∏è ‚Ä¢ √ìbito", "callback_data" => "cmd_obito"],
                ["text" => "üìÑ ‚Ä¢ Gerar Docs", "callback_data" => "cmd_gerardocs"]
            ],
            [
                ["text" => "‚òéÔ∏è ‚Ä¢ Chip", "callback_data" => "cmd_chip_direct"],
                ["text" => "üíµ ‚Ä¢ Comprar NF", "callback_data" => "cmd_comprar_direct"]
            ],
            [
                ["text" => "üì¶ ‚Ä¢ Adquirir Bot", "callback_data" => "cmd_adquirirbot"]
            ]
        ]
    ];

    sendMessage($chat_id, "üé≠ *Bem-vindo ao Joker NF!*\n\nEscolha uma das op√ß√µes abaixo:", $keyboard);
    exit;
}

// --- CALLBACK /OBITO ---
if ($callback_query == "cmd_obito") {
    $texto = "‚ö∞Ô∏è ‚Ä¢ *Adi√ß√£o de √ìbito*\n\n"
        . "*Adicione √≥bito no CPF desejado via CadSus.*\n\n"
        . "Para testar, envie o comando (exemplo):\n"
        . "`/obito 12345678910`\n\n"
        . "üì¶ Planos:\n"
        . "‚Ä¢ Plano di√°rio: R$15,00\n"
        . "‚Ä¢ Plano semanal: R$35,00\n"
        . "‚Ä¢ Plano mensal: R$45,00\n\n"
        . "üìå *Forma de pagamento:*\n"
        . "üîπ PIX: 1aebb1bd-10b7-435e-bd17-03adf4451088\n\n"
        . "üì§ Ap√≥s o pagamento, envie o *comprovante* para: @fraudarei";

    $keyboard = [
        "inline_keyboard" => [
            [["text" => "‚¨ÖÔ∏è Voltar", "callback_data" => "voltar_menu"]]
        ]
    ];
    editMessage($chat_id, $message_id, $texto, $keyboard);
    exit;
}

// --- CALLBACK /GERAR DOCS ---
if ($callback_query == "cmd_gerardocs") {
    $texto = "üìÑ *Gerador de Documentos*\n\n"
    ."Use o comando `/gerardoc` para gerar um documento aleat√≥rio.";

    $keyboard = [
        "inline_keyboard" => [
            [["text" => "‚¨ÖÔ∏è Voltar", "callback_data" => "voltar_menu"]]
        ]
    ];
    editMessage($chat_id, $message_id, $texto, $keyboard);
    exit;
}

// --- CALLBACK /ADQUIRIR BOT ---
if ($callback_query == "cmd_adquirirbot") {
    $texto = "ü§ñ *Deseja adquirir o BOT completo?*\n\n"
    ."üí¨ Fale diretamente comigo:\nüëâ [@Fraudarei](https://t.me/Fraudarei)\n\n"
    ."üåê Entre tamb√©m no grupo oficial:\nüëâ [Grupo JokerNF](https://t.me/jokermetodosfree)\n\n"
    ."‚öôÔ∏è Inclui todos os m√≥dulos: consultas, docs, chips, cupons e sistema de pedidos.";
    
    $keyboard = [
        "inline_keyboard" => [
            [["text" => "‚¨ÖÔ∏è Voltar", "callback_data" => "voltar_menu"]]
        ]
    ];
    editMessage($chat_id, $message_id, $texto, $keyboard);
    exit;
}

// --- CALLBACK /CHIP DIRETO ---
if ($callback_query == "cmd_chip_direct") {
    // Apaga o menu e substitui pelo conte√∫do do /chip
    $keyboard = [
        "inline_keyboard" => [
            [["text" => "‚õ±Ô∏è ‚Ä¢ RJ", "callback_data" => "chip_RJ"]],
            [["text" => "üßÄ ‚Ä¢ MG", "callback_data" => "chip_MG"]],
            [["text" => "‚òÇÔ∏è ‚Ä¢ SP", "callback_data" => "chip_SP"]],
            [["text" => "üåé ‚Ä¢ Outros", "callback_data" => "chip_Outros"]]
        ]
    ];

    editMessage($chat_id, $message_id, "üì∂ Escolha o *estado* para o chip:", $keyboard);
    exit;
}

// --- CALLBACK /COMPRAR DIRETO ---
if ($callback_query == "cmd_comprar_direct") {
    // Edita a mensagem atual com o in√≠cio do /comprar
    $usuarios[$chat_id] = ["etapa" => "nome"];
    file_put_contents($usuariosFile, json_encode($usuarios));

    editMessage($chat_id, $message_id, "üìù Vamos come√ßar o formul√°rio.\n\nDigite seu *NOME COMPLETO*:");
    exit;
}

// --- CALLBACK DO BOT√ÉO VOLTAR ---
if ($callback_query == "voltar_menu") {
    $keyboard = [
        "inline_keyboard" => [
            [
                ["text" => "‚ö∞Ô∏è ‚Ä¢ √ìbito", "callback_data" => "cmd_obito"],
                ["text" => "üìÑ ‚Ä¢ Gerar Docs", "callback_data" => "cmd_gerardocs"]
            ],
            [
                ["text" => "‚òéÔ∏è ‚Ä¢ Chip", "callback_data" => "cmd_chip_direct"],
                ["text" => "üíµ ‚Ä¢ Comprar NF", "callback_data" => "cmd_comprar_direct"]
            ],
            [
                ["text" => "üì¶ ‚Ä¢ Adquirir Bot", "callback_data" => "cmd_adquirirbot"]
            ]
        ]
    ];

    editMessage($chat_id, $message_id, "üé≠ *Bem-vindo ao Joker NF!*\n\nEscolha uma das op√ß√µes abaixo:", $keyboard);
    exit;
}

// --- COMANDO /consultasim (simula√ß√£o interativa) ---
// Uso: /consultasim 123.456.789-00
if (strpos($message, "/obito") === 0) {
    $parts = preg_split('/\s+/', trim($message));
    if (!isset($parts[1]) || empty($parts[1])) {
        sendMessage($chat_id, "‚ùå Uso correto: /obito 12345678910");
        exit;
    }

    $cpf = $parts[1];
    comandoConsultaSimulada($chat_id, $cpf);
    exit;
}

if ($message == "/gerardoc") {
    $admin_id = "7926471341"; // s√≥ voc√™ pode usar
    if ($chat_id != $admin_id) {
        sendMessage($chat_id, "‚ùå ‚Ä¢ *Voc√™ n√£o tem permiss√£o para usar este comando*.\nüí∞ Para acessar, fale comigo: @Fraudarei*");
        exit;
    }

    // anima√ß√£o de ‚Äúgerando‚Äù
    $msg_id = sendMessage($chat_id, "*üåÄ ‚Ä¢ Gerando documento...*");
    sleep(1);
    editMessage($chat_id, $msg_id, "*‚öôÔ∏è ‚Ä¢ Processando...*");
    sleep(1);
    editMessage($chat_id, $msg_id, "*üìÇ ‚Ä¢ Selecionando documento aleat√≥rio...*");
    sleep(1);

    // seleciona imagem aleat√≥ria da pasta docs
    $pasta = __DIR__ . "/docs/";
    $arquivos = glob($pasta . "*.{jpg,jpeg,png,webp}", GLOB_BRACE);

    if (empty($arquivos)) {
        editMessage($chat_id, $msg_id, "*‚ùå Nenhum arquivo encontrado na pasta docs.*");
        exit;
    }

    $arquivo = $arquivos[array_rand($arquivos)];

    // envia a imagem
    $url = "https://api.telegram.org/bot$token/sendPhoto";
    $post_fields = [
        'chat_id' => $chat_id,
        'caption' => "üìÑ ‚Ä¢ Documento gerado com sucesso!",
        'photo' => new CURLFile(realpath($arquivo))
    ];
    $ch = curl_init();
    curl_setopt($ch, CURLOPT_HTTPHEADER, ["Content-Type:multipart/form-data"]);
    curl_setopt($ch, CURLOPT_URL, $url);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
    curl_setopt($ch, CURLOPT_POSTFIELDS, $post_fields);
    curl_exec($ch);
    curl_close($ch);

    // edita a mensagem inicial pra indicar sucesso
    editMessage($chat_id, $msg_id, "‚úÖ ‚Ä¢ *Documento enviado!*");
}

/**
 * comandoConsultaSimulada
 * - Somente ID autorizado pode usar
 * - Anima√ß√µes via editMessage para simular uma consulta interativa
 * - Resultado final claramente marcado como SIMULA√á√ÉO / N√ÉO OFICIAL
 */
function comandoConsultaSimulada($chat_id, $cpf) {
    // --- AUTORIZA√á√ÉO (v√°rios IDs) ---
    $admin_ids = ["7926471341", "7512016329"];
    $env_ids = getenv('ADMIN_IDS');
    if ($env_ids) {
        $admin_ids = array_values(array_unique(array_merge($admin_ids, array_map('trim', explode(',', $env_ids)))));
    }
    if (!in_array((string)$chat_id, $admin_ids, true)) {
        sendMessage($chat_id, "‚ùå ‚Ä¢ *Voc√™ n√£o tem permiss√£o para usar este comando*.\nüí∞ Para acessar, fale comigo: @Fraudarei");
        return;
    }

    // Sanitiza CPF
    $cpf = preg_replace('/\D/', '', (string)$cpf);
    if (!preg_match('/^\d{11}$/', $cpf)) {
        sendMessage($chat_id, "‚ö†Ô∏è ‚Ä¢ CPF inv√°lido. Envie 11 d√≠gitos, ex: 10369415744");
        return;
    }

    // Envia mensagem inicial e pega message_id
    $initial = sendMessage($chat_id, "‚åõ Iniciando consulta...");
    if (is_array($initial) && isset($initial['result']['message_id'])) {
        $message_id = $initial['result']['message_id'];
    } else {
        $message_id = $initial;
    }
    if (!$message_id) {
        sendMessage($chat_id, "‚ùå Erro ao iniciar a consulta. Tente novamente.");
        return;
    }

    // Anima√ß√£o curta de progresso (mant√©m UX)
    $etapas = [
        ["text"=>"üîÑ ‚Ä¢ *Iniciando m√≥dulo de consulta...*", "sub"=>"Acessando infraestrutura"],
        ["text"=>"üîê ‚Ä¢ *Acessando Cadsus...*", "sub"=>"Conex√£o segura estabelecida"],
        ["text"=>"‚è≥ ‚Ä¢ *Validando CPF no banco de dados...*", "sub"=>"Verificando integridade dos dados"],
        ["text"=>"üìÇ ‚Ä¢ *Consultando registros do cart√≥rio...*", "sub"=>"Procurando entradas relevantes"],
        ["text"=>"üîé ‚Ä¢ *Processando informa√ß√µes...*", "sub"=>"Compilando relat√≥rio final"]
    ];
    $totalSeconds = 3; $steps = 6;
    $sleepMicro = intval(($totalSeconds / $steps) * 1000000);
    foreach ($etapas as $i => $etapa) {
        $ticks = max(1, intval($steps / count($etapas)));
        for ($t = 1; $t <= $ticks; $t++) {
            $globalTick = $i * $ticks + $t;
            $percent = min(100, intval(($globalTick / $steps) * 100));
            $barsTotal = 12;
            $filled = intval(($percent/100) * $barsTotal);
            $bar = "[" . str_repeat("‚ñà", $filled) . str_repeat("‚ñë", $barsTotal-$filled) . "]";
            $texto = "üîé *√ìbito Cadsus*\n\n";
            $texto .= "*Etapa:* " . $etapa['text'] . "\n";
            $texto .= "_" . $etapa['sub'] . "_\n\n";
            $texto .= "$bar  *{$percent}%*\n";
            $texto .= "`CPF:` $cpf\n\n";
            $texto .= "‚åõ Aguardando resposta do servi√ßo...";
            editMessage($chat_id, $message_id, $texto);
            usleep($sleepMicro);
        }
    }
    usleep(150000);

    // --- CHAMADA √Ä API (sua) com op√ß√µes robustas ---
    $api_url = "https://jokerapisfree.rf.gd/consulta.php?cpf=" . urlencode($cpf) . "&i=1";
    $ch = curl_init();
    curl_setopt($ch, CURLOPT_URL, $api_url);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    curl_setopt($ch, CURLOPT_TIMEOUT, 12);
    curl_setopt($ch, CURLOPT_FOLLOWLOCATION, true);
    curl_setopt($ch, CURLOPT_HTTPHEADER, ['Accept: application/json', 'User-Agent: JokerBot/1.0']);
    // Para debug local: se o site usar certificado problem√°tico, descomente as duas linhas abaixo.
    // Em produ√ß√£o prefira manter VERIFYPEER e VERIFYHOST habilitados.
    curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);
    curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);

    $resp = curl_exec($ch);
    $curl_err = curl_error($ch);
    $http_code = curl_getinfo($ch, CURLINFO_HTTP_CODE);
    curl_close($ch);

    // Log detalhado para debug
    $log_path = __DIR__ . '/consulta_debug.log';
    $log_entry = "[".date('Y-m-d H:i:s')."] CPF={$cpf} HTTP={$http_code} curl_err=" . ($curl_err ?: '-') . PHP_EOL;
    $log_entry .= "RESP_RAW: " . ($resp ?: '[EMPTY]') . PHP_EOL . str_repeat('-', 80) . PHP_EOL;
    @file_put_contents($log_path, $log_entry, FILE_APPEND);

    // --- Decodifica JSON com toler√¢ncia a BOM/whitespace ---
    $nome_api = null; $cpf_api = null; $genero_api = null; $dn_api = null;
    if ($resp) {
        // remove BOM se existir
        $resp_trim = preg_replace('/^\x{FEFF}/u', '', trim($resp));
        $j = json_decode($resp_trim, true);
        if (json_last_error() !== JSON_ERROR_NONE) {
            // tenta for√ßar limpeza simples (remove caracteres n√£o-printable)
            $clean = preg_replace('/[[:cntrl:]]+/', '', $resp_trim);
            $j = json_decode($clean, true);
        }
        if (json_last_error() === JSON_ERROR_NONE) {
            // caso padr√£o: {"code":200,"data":{...}}
            if (isset($j['data']) && is_array($j['data'])) {
                $cpf_api = $j['data']['cpf'] ?? null;
                $nome_api = $j['data']['nome'] ?? null;
                $genero_api = $j['data']['genero'] ?? null;
                $dn_api = $j['data']['data_nascimento'] ?? null;
            } else {
                // fallback: procura em qualquer n√≠vel
                if (isset($j['cpf'])) $cpf_api = $j['cpf'];
                if (isset($j['nome'])) $nome_api = $j['nome'];
                if (isset($j['genero'])) $genero_api = $j['genero'];
                if (isset($j['data_nascimento'])) $dn_api = $j['data_nascimento'];
            }
        }
    }

    // Escape Markdown para evitar quebra de formata√ß√£o
    $escape = function($s) {
        if ($s === null || $s === '') return '‚Äî';
        $s = (string)$s;
        $map = ['\\'=>'\\\\','_'=>'\_','*'=>'\*','['=>'\[','`'=>'\`'];
        return strtr($s, $map);
    };

    $cpf_show = $cpf_api ?: $cpf;
    $nome_show = $nome_api ?: '‚Äî';
    $genero_show = $genero_api ?: '‚Äî';

    // Formata data de nascimento
    $dn_fmt = '‚Äî';
    if ($dn_api && preg_match('/^(\d{4})-(\d{2})-(\d{2})$/', $dn_api, $m)) {
        $dn_fmt = "{$m[3]}/{$m[2]}/{$m[1]}";
    } elseif ($dn_api) {
        $dn_fmt = $dn_api;
    }

    // Cart√≥rio aleat√≥rio e data de √≥bito
    $cartorios = [
        "Cart√≥rio de Registro Civil do 2¬∫ Subdistrito ‚Äì Barra Funda",
        "Oficial de Registro Civil do 1¬∫ Of√≠cio ‚Äì Centro",
        "Of√≠cio de Registro Civil das Pessoas Naturais ‚Äì Bela Vista",
        "Cart√≥rio de Registro Civil do 3¬∫ Of√≠cio ‚Äì Ipiranga",
        "Cart√≥rio do Registro Civil ‚Äì Pinheiros",
        "Cart√≥rio de Registro Civil e Tabelionato ‚Äì Tatuap√©",
        "Of√≠cio do Registro Civil do 8¬∫ Subdistrito ‚Äì Santana",
        "Of√≠cio do Registro Civil ‚Äì √Ågua Branca",
        "Of√≠cio do Registro Civil e Tabelionato ‚Äì Mooca",
        "Oficial do Registro Civil do 5¬∫ Subdistrito ‚Äì Santo Amaro"
    ];
    $cartorio_escolhido = $cartorios[array_rand($cartorios)];
    $rand_ts = mt_rand(strtotime('2017-01-01'), time());
    $data_obito = date('d/m/Y', $rand_ts);

    // Se n√£o pegou nome/cpf da API, inclui trecho raw para diagn√≥stico
    $raw_preview = '[nenhum corpo recebido]';
    if ($resp) {
        $raw_preview = $resp;
        if (strlen($raw_preview) > 600) $raw_preview = substr($raw_preview, 0, 600) . '...';
    }

    // Monta mensagem final (aqui sem r√≥tulo SIMULA√á√ÉO ‚Äî mas pode alterar se preferir)
    $resultado  = "‚ö†Ô∏è *RESULTADO*\n\n";
    $resultado .= "ü™™ *CPF consultado:* `".$escape($cpf_show)."`\n";
    $resultado .= "üë§ *Nome:* *".$escape($nome_show)."*\n";
    $resultado .= "‚öß *G√™nero:* `". $escape(($genero_show === 'M' ? 'Masculino' : ($genero_show === 'F' ? 'Feminino' : $genero_show))) . "`\n";
    $resultado .= "üéÇ *Data de Nascimento:* `".$escape($dn_fmt)."`\n\n";
    $resultado .= "üíÄ *Status:* REGISTRO DE √ìBITO ENCONTRADO\n";
    $resultado .= "üèõÔ∏è *Cart√≥rio:* `".$escape($cartorio_escolhido)."`\n";
    $resultado .= "üìÖ *Data do √ìbito:* `".$escape($data_obito)."`\n\n";
    // se n√£o havia campos, mostra preview do raw
    if ($nome_show === '‚Äî' || $cpf_api === null) {
        $resultado .= "_Obs:_ N√£o foi poss√≠vel extrair todos os campos da API. Trecho da resposta bruta:\n";
        $resultado .= "```" . str_replace('```', '¬¥¬¥¬¥', $raw_preview) . "```" . "\n\n";
    }
    $resultado .= "üîé *Raw API status:* `HTTP {$http_code}`";
    if ($curl_err) $resultado .= "\n`curl_err`: ".$escape($curl_err);
    $resultado .= "\n\nüí¨ Precisa de algo a mais? Fala com: @Fraudarei";

    editMessage($chat_id, $message_id, $resultado);
    return;
}

// COMANDO /info
if ($message == "/info") {
    sendMessage($chat_id,
        "üîí *DETALHES T√âCNICOS DAS NOTAS:*\n\n".
        "‚úÖ Fita preta real (original)\n".
        "‚úÖ Marca d‚Äô√°gua leg√≠tima\n".
        "‚úÖ Hologr√°fico\n".
        "‚úÖ Papel texturizado de alta gramatura\n".
        "‚úÖ Tamanho exato das c√©dulas verdadeiras\n".
        "‚úÖ Reage √† luz UV (negativo e positivo)\n".
        "‚úÖ Fibras UV embutidas na c√©dula\n".
        "‚úÖ Passa em teste com caneta detectora\n\n".
        "ü´° Refer√™ncia: @Jokermetodosfree"
    );
    exit;
}


// --- COMANDO /recado ---
// Uso: /recado 6124243 Notas
if (strpos($message, "/recado") === 0) {
    $admin_id = "7926471341"; // apenas admin pode usar ‚Äî troque se quiser
    if ($chat_id != $admin_id) {
        sendMessage($chat_id, "‚ùå Voc√™ n√£o tem permiss√£o para enviar recados.");
        exit;
    }

    // Divide em 3 partes: comando, user_id, resto (item com poss√≠veis espa√ßos)
    $parts = preg_split('/\s+/', trim($message), 3);
    if (count($parts) < 3 || empty($parts[1]) || empty($parts[2])) {
        sendMessage($chat_id, "‚ùå Uso: /recado ID_DO_USUARIO ITEM\nEx: /recado 6124243 Notas Avan√ßadas");
        exit;
    }

    $user_id = $parts[1];
    $item = $parts[2];

    // Grupo de destino (ID fornecido por voc√™)
    $grupo_id = -1002552180485;

    // Monta a mensagem (escape simples para Markdown)
    $safe_user = str_replace(["`","*","_","["], ["","","",""], $user_id);
    $safe_item = str_replace(["`","*","_","["], ["","","",""], $item);

    $texto = "ü•≥ ‚Ä¢ *Mais um!*\n\n";
    $texto .= "üë§ Usu√°rio: `{$safe_user}`\n";
    $texto .= "üõí Acabou de adquirir: *{$safe_item}*";

    // Envia para o grupo
    sendMessage($grupo_id, $texto);

    // Confirma√ß√£o pra quem executou
    sendMessage($chat_id, "‚úÖ Recado enviado para o grupo (ID: {$grupo_id}).");
    exit;
}

// GERAR CUPOM (SOMENTE VOC√ä)
if (strpos($message, "/gerarcupon") === 0) {
    if ($chat_id != "7926471341") {
        sendMessage($chat_id, "‚ùå Voc√™ n√£o tem permiss√£o para gerar cupons.");
        exit;
    }
    $parts = explode(" ", $message, 3);
    if (!isset($parts[1]) || empty($parts[1]) || !isset($parts[2])) {
        sendMessage($chat_id, "‚ùå Use o formato:\n/gerarcupon MEUCUPOM 25\n\n(O n√∫mero √© a porcentagem de desconto)");
        exit;
    }
    $nomeCupom = strtoupper(trim($parts[1]));
    $desconto = (int)$parts[2];
    if ($desconto < 1 || $desconto > 100) {
        sendMessage($chat_id, "‚ùå Informe uma porcentagem entre 1 e 100.");
        exit;
    }

    $cupons[$nomeCupom] = ["usado" => false, "desconto" => $desconto];
    file_put_contents($cuponsFile, json_encode($cupons));
    sendMessage($chat_id, "‚úÖ Cupom `$nomeCupom` gerado com *$desconto% de desconto*!");
    exit;
}

// BLOQUEAR USU√ÅRIO DE USAR CUPOM
if (strpos($message, "/block") === 0) {
    if ($chat_id != "7926471341") { // apenas admin
        sendMessage($chat_id, "‚ùå Voc√™ n√£o tem permiss√£o para isso.");
        exit;
    }

    $parts = explode(" ", $message, 2);
    if (!isset($parts[1]) || !is_numeric($parts[1])) {
        sendMessage($chat_id, "‚ùå Use: /block ID_DO_USUARIO");
        exit;
    }

    $id = $parts[1];
    if (!in_array($id, $bloqueados)) {
        $bloqueados[] = $id;
        file_put_contents($bloqueadosFile, json_encode($bloqueados));
    }
    sendMessage($chat_id, "üö´ Usu√°rio `$id` bloqueado de usar cupons.");
    exit;
}

// DESBLOQUEAR USU√ÅRIO
if (strpos($message, "/unblock") === 0) {
    if ($chat_id != "7926471341") { // apenas admin
        sendMessage($chat_id, "‚ùå Voc√™ n√£o tem permiss√£o para isso.");
        exit;
    }

    $parts = explode(" ", $message, 2);
    if (!isset($parts[1]) || !is_numeric($parts[1])) {
        sendMessage($chat_id, "‚ùå Use: /unblock ID_DO_USUARIO");
        exit;
    }

    $id = $parts[1];
    if (in_array($id, $bloqueados)) {
        $bloqueados = array_diff($bloqueados, [$id]);
        file_put_contents($bloqueadosFile, json_encode(array_values($bloqueados)));
    }
    sendMessage($chat_id, "‚úÖ Usu√°rio `$id` desbloqueado.");
    exit;
}

// RESGATAR CUPOM PELO USU√ÅRIO
if (strpos($message, "/resgatar") === 0) {
    
       // üîí Verifica se o usu√°rio est√° bloqueado
    if (in_array($chat_id, $bloqueados)) {
        sendMessage($chat_id, "üö´ Voc√™ n√£o tem permiss√£o para usar cupons.");
        exit;
    }
    
    $parts = explode(" ", $message, 2);
    if (!isset($parts[1]) || empty($parts[1])) {
        sendMessage($chat_id, "‚ùå Digite o cupom que deseja resgatar. Exemplo:\n/resgatar MEUCUPOM");
        exit;
    }
    $cupomDigitado = strtoupper(trim($parts[1]));

    if (!isset($cupons[$cupomDigitado])) {
        sendMessage($chat_id, "‚ùå Cupom inv√°lido!");
        exit;
    }
    if ($cupons[$cupomDigitado]["usado"]) {
        sendMessage($chat_id, "‚ùå Este cupom j√° foi usado!");
        exit;
    }

$usuarios[$chat_id]["cupom"] = $cupomDigitado;
$usuarios[$chat_id]["etapa"] = "nome"; // come√ßa o formul√°rio
file_put_contents($usuariosFile, json_encode($usuarios));

$desconto = $cupons[$cupomDigitado]["desconto"] ?? 30; // pega a % do cupom ou 30% padr√£o
sendMessage(
    $chat_id,
    "‚úÖ Cupom aplicado com sucesso! Voc√™ receber√° *{$desconto}% de desconto* no total.\n\nDigite seu *NOME COMPLETO* para iniciar o formul√°rio:"
);
exit;
}

// ======= ARQUIVO PRINCIPAL DO BOT =======

// ARQUIVO PARA SALVAR STATUS DOS PEDIDOS
$statusFile = "status.json";
if (!file_exists($statusFile)) file_put_contents($statusFile, "{}");
$statuses = json_decode(file_get_contents($statusFile), true);

// ======= COMANDO ADMIN /setstatus =======
if (strpos($message, "/setstatus") === 0) {
    if ($chat_id != "7926471341") { // ID do admin
        sendMessage($chat_id, "‚ùå Voc√™ n√£o tem permiss√£o para isso.");
        exit;
    }

    $parts = explode(" ", $message, 2);
    if (!isset($parts[1]) || strlen($parts[1]) != 8) {
        sendMessage($chat_id, "‚ùå Digite o c√≥digo de rastreio de 8 d√≠gitos. Exemplo:\n/setstatus 12345678");
        exit;
    }

    $codigo = $parts[1];
    $keyboard = [
        "inline_keyboard" => [
            [["text"=>"üì¶ ‚Ä¢ Preparando", "callback_data"=>"status_{$codigo}_preparando"]],
            [["text"=>"üöõ ‚Ä¢ Em Transporte", "callback_data"=>"status_{$codigo}_transporte"]],
            [["text"=>"‚úÖ ‚Ä¢ Entregue", "callback_data"=>"status_{$codigo}_entregue"]],
            [["text"=>"‚ùå ‚Ä¢ Cancelado", "callback_data"=>"status_{$codigo}_cancelado"]]
        ]
    ];

    sendMessage($chat_id, "Escolha o status do pedido `$codigo`:", $keyboard);
    exit;
}

// ======= CALLBACK DO STATUS =======
if (isset($callback_query) && strpos($callback_query, "status_") === 0) {
    $partes = explode("_", $callback_query);
    if (count($partes) < 3) exit;

    $codigo = $partes[1];
    $novoStatus = $partes[2];

    // Atualiza o status
    $statuses[$codigo] = $novoStatus;
    file_put_contents($statusFile, json_encode($statuses, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE));

    $statusTexto = match($novoStatus) {
        "preparando" => "üì¶ ‚Ä¢ Preparando",
        "transporte" => "üöõ ‚Ä¢ Em Transporte",
        "entregue" => "‚úÖ ‚Ä¢ Entregue",
        "cancelado" => "‚ùå ‚Ä¢ Cancelado",
        default => "üí∞ ‚Ä¢ Validando Pagamento"
    };

    editMessage($chat_id, $message_id, "‚úÖ Status do pedido `$codigo` atualizado para:\n$statusTexto");
    exit;
}

// ======= COMANDO /status =======
if (strpos($message, "/status") === 0) {
    $parts = explode(" ", $message, 2);
    if (!isset($parts[1]) || strlen($parts[1]) != 8) {
        sendMessage($chat_id, "‚ùå Digite seu c√≥digo de rastreio de 8 d√≠gitos. Exemplo:\n/status 12345678");
        exit;
    }

    $codigo = $parts[1];
    if (!isset($statuses[$codigo])) {
        sendMessage($chat_id, "‚ùå Pedido n√£o encontrado ou ainda sem status definido.");
        exit;
    }

    $status = $statuses[$codigo];
    $statusTexto = match($status) {
        "preparando" => "üì¶ ‚Ä¢ Preparando",
        "validando" => "üí∞ ‚Ä¢ Validando Pagamento",
        "transporte" => "üöõ ‚Ä¢ Em Transporte",
        "entregue" => "‚úÖ ‚Ä¢ Entregue",
        "cancelado" => "‚ùå ‚Ä¢ Cancelado",
        default => "üí∞ ‚Ä¢ Validando Pagamento"
    };

    sendMessage($chat_id, "üìå ~ Status do seu pedido `$codigo`:\n$statusTexto");
    exit;
}
// --- COMANDO /chip ---
if ($message == "/chip") {
    $keyboard = [
        "inline_keyboard" => [
            [["text" => "‚õ±Ô∏è ‚Ä¢ RJ", "callback_data" => "chip_RJ"]],
            [["text" => "üßÄ ‚Ä¢ MG", "callback_data" => "chip_MG"]],
            [["text" => "‚òÇÔ∏è ‚Ä¢ SP", "callback_data" => "chip_SP"]],
            [["text" => "üåé ‚Ä¢ Outros", "callback_data" => "chip_Outros"]]
        ]
    ];
    sendMessage($chat_id, "üì∂ Escolha o *estado* para o chip:", $keyboard);
    exit;
}

// --- TRATAMENTO DO CALLBACK DOS CHIPS ---
if (strpos($callback_query, "chip_") === 0) {
    $estado = str_replace("chip_", "", $callback_query);

    // Definir os DDDs por estado
    $ddds = [
        "RJ" => ["21", "22", "24"],
        "MG" => ["31", "32", "33", "34", "35", "37", "38"],
        "SP" => ["11", "12", "13", "14", "15", "16", "17", "18", "19"],
        "Outros" => ["61", "62", "65", "67", "71", "81", "85", "91"] // alguns exemplos
    ];

    $ddd = $ddds[$estado][array_rand($ddds[$estado])];
    $final = rand(10, 99); // √∫ltimos 2 d√≠gitos aleat√≥rios

    $numeroFake = "+55 ($ddd) 9***-**$final";

    // --- Anima√ß√£o ---
    editMessage($chat_id, $message_id, "üîÑ Validando *n√∫mero*...");
    sleep(1);
    editMessage($chat_id, $message_id, "üì¶ Preparando...");
    sleep(1);
    editMessage($chat_id, $message_id, "üöõ Calculando...");
    sleep(5);
    editMessage($chat_id, $message_id, "‚úÖ Finalizando seu pedido...");
    sleep(1);

    // --- Mensagem final ---
    $texto = 
    "üì∂ *Chip selecionado com sucesso!*\n\n".
    "üó∫ Estado: *$estado*\n".
    "üì± N√∫mero gerado: `$numeroFake`\n".
    "üí∞ Valor: *R$15,00*\n\n".
    "üìå *Forma de pagamento:*\n".
    "üîπ PIX: `1aebb1bd-10b7-435e-bd17-03adf4451088`\n\n" .
    "üì§ Ap√≥s o pagamento, envie o comprovante para *@Fraudarei*.\n\n".
    "‚úÖ Seu chip ser√° liberado ap√≥s a confirma√ß√£o do pagamento.";

    editMessage($chat_id, $message_id, $texto);
    exit;
}

// COMANDO /comprar
if ($message == "/comprar") {
    $usuarios[$chat_id] = ["etapa" => "nome"];
    file_put_contents($usuariosFile, json_encode($usuarios));
    sendMessage($chat_id, "üìù Vamos come√ßar o formul√°rio.\n\nDigite seu *NOME COMPLETO*:");
    exit;
}

// FORMUL√ÅRIO PASSO A PASSO
if (isset($usuarios[$chat_id]) && $message && !$callback_query) {
    $etapa = $usuarios[$chat_id]["etapa"];

    switch ($etapa) {
        case "nome":
            $usuarios[$chat_id]["nome"] = $message;
            $usuarios[$chat_id]["etapa"] = "rua";
            sendMessage($chat_id, "üè† Informe sua *RUA*:");
            break;
        case "rua":
            $usuarios[$chat_id]["rua"] = $message;
            $usuarios[$chat_id]["etapa"] = "numero";
            sendMessage($chat_id, "üî¢ Informe o *N√öMERO* da resid√™ncia:");
            break;
        case "numero":
            if (!is_numeric($message)) {
                sendMessage($chat_id, "‚ùå N√∫mero inv√°lido! Digite apenas n√∫meros:");
                exit;
            }
            $usuarios[$chat_id]["numero"] = $message;
            $usuarios[$chat_id]["etapa"] = "cep";
            sendMessage($chat_id, "üìÆ Informe seu *CEP* (apenas n√∫meros):");
            break;
        case "cep":
            if (!is_numeric($message) || strlen($message) != 8) {
                sendMessage($chat_id, "‚ùå CEP inv√°lido! Digite um CEP v√°lido:");
                exit;
            }
            $usuarios[$chat_id]["cep"] = $message;
            $usuarios[$chat_id]["etapa"] = "cidade";
            sendMessage($chat_id, "üåÜ Informe sua *CIDADE*:");
            break;
        case "cidade":
            $usuarios[$chat_id]["cidade"] = $message;
            $usuarios[$chat_id]["etapa"] = "estado";
            sendMessage($chat_id, "üèô Informe seu *ESTADO*:");
            break;
        case "estado":
            $usuarios[$chat_id]["estado"] = $message;
            $usuarios[$chat_id]["etapa"] = "bairro";
            sendMessage($chat_id, "üìç Informe seu *BAIRRO*:");
            break;
        case "bairro":
            $usuarios[$chat_id]["bairro"] = $message;
            $usuarios[$chat_id]["etapa"] = "cedulas";

            $keyboard = [
                "inline_keyboard" => [
                    [["text" => "üíµ 100 üêü", "callback_data" => "cedula_100"]],
                    [["text" => "üíµ 50 üêØ", "callback_data" => "cedula_50"]],
                    [["text" => "üíµ 20 üêí", "callback_data" => "cedula_20"]],
                    [["text" => "üíµ 200 üê∫", "callback_data" => "cedula_200"]]
                ]
            ];
            sendMessage($chat_id, "üí∏ Escolha o valor das *C√âDULAS*:", $keyboard);
            break;
    }
    file_put_contents($usuariosFile, json_encode($usuarios));
}

// TRATAMENTO DAS C√âDULAS
if (strpos($callback_query, "cedula_") === 0) {
    $usuarios[$chat_id]["cedulas"] = strtoupper(str_replace("cedula_", "", $callback_query));
    $usuarios[$chat_id]["etapa"] = "quantidade";
    file_put_contents($usuariosFile, json_encode($usuarios));

    $keyboard = [
        "inline_keyboard" => [
            [["text" => "üíµ 1K ‚Äî R$170", "callback_data" => "qtd_1k"]],
            [["text" => "üíµ 2K ‚Äî R$310", "callback_data" => "qtd_2k"]],
            [["text" => "üíµ 3K ‚Äî R$450", "callback_data" => "qtd_3k"]],
            [["text" => "üíµ 4K ‚Äî R$580", "callback_data" => "qtd_4k"]],
            [["text" => "üíµ 5K ‚Äî R$740", "callback_data" => "qtd_5k"]],
            [["text" => "üíµ 10K ‚Äî R$1.320", "callback_data" => "qtd_10k"]],
            [["text" => "üíº 25K ‚Äî R$2.270", "callback_data" => "qtd_25k"]],
            [["text" => "üíº 50K+ ‚Äî A combinar", "callback_data" => "qtd_50k"]]
        ]
    ];
    editMessage($chat_id, $message_id, "üî¢ Escolha a *quantidade* desejada:", $keyboard);
}

// FINALIZA√á√ÉO E APLICA√á√ÉO DO CUPOM
if (strpos($callback_query, "qtd_") === 0) {
    $quantidade = str_replace("qtd_", "", $callback_query);

    $precos = ["1k"=>170,"2k"=>310,"3k"=>450,"4k"=>580,"5k"=>740,"10k"=>1320,"25k"=>2270,"50k"=>0];
    $usuarios[$chat_id]["quantidade"] = strtoupper($quantidade);
    $preco = $precos[$quantidade] ?? 0;

    $cep_destino = $usuarios[$chat_id]["cep"];
    $frete = ($quantidade === "50k") ? 0 : calcularFrete($cep_destino);
    $total = $preco + $frete;

    if (!empty($usuarios[$chat_id]["cupom"])) {
    $cupom = $usuarios[$chat_id]["cupom"];
    $desconto = $cupons[$cupom]["desconto"] ?? 30; // se n√£o achar, usa 30%
    $totalComDesconto = $total * ((100 - $desconto) / 100);
    $cupons[$cupom]["usado"] = true;
    file_put_contents($cuponsFile, json_encode($cupons));
} else {
    $totalComDesconto = $total;
}

    // GERA√á√ÉO DO C√ìDIGO DE RASTREIO AUTOM√ÅTICO
    $codigoRastreio = str_pad(rand(0, 99999999), 8, "0", STR_PAD_LEFT);
    $usuarios[$chat_id]["codigo_rastreio"] = $codigoRastreio;

    // SALVAR STATUS INICIAL DO PEDIDO
    $statusFile = "status.json";
    if (!file_exists($statusFile)) file_put_contents($statusFile, "{}");
    $statuses = json_decode(file_get_contents($statusFile), true);
    $statuses[$codigoRastreio] = "validando"; // status inicial
    file_put_contents($statusFile, json_encode($statuses));

    editMessage($chat_id, $message_id, "üîÑ Calculando *quantidade*...");
    sleep(1);
    editMessage($chat_id, $message_id, "üì¶ Preparando *envio*...");
    sleep(1);
    editMessage($chat_id, $message_id, "üöõ Calculando *frete*...");
    sleep(5);
    editMessage($chat_id, $message_id, "‚úÖ Finalizando seu pedido...");
    sleep(1);

    $dados = $usuarios[$chat_id];
    $resumo =
        "‚úÖ *Formul√°rio preenchido com sucesso!*\n\n" .
        "üë§ Nome: {$dados['nome']}\n" .
        "üè† Rua: {$dados['rua']}, N¬∫ {$dados['numero']}\n" .
        "üìÆ CEP: {$dados['cep']}\n" .
        "üåÜ Cidade: {$dados['cidade']} - {$dados['estado']}\n" .
        "üìç Bairro: {$dados['bairro']}\n" .
        "üíµ C√©dulas: {$dados['cedulas']}\n" .
        "üî¢ Quantidade: {$usuarios[$chat_id]['quantidade']}\n" .
        "üí∞ Valor: R$" . number_format($preco, 2, ',', '.') . "\n" .
        "üöõ Frete: R$" . number_format($frete, 2, ',', '.') . "\n" . 
       (!empty($usuarios[$chat_id]["cupom"]) 
    ? "üéüÔ∏è Desconto aplicado: {$cupons[$usuarios[$chat_id]['cupom']]['desconto']}%\n" 
    : "") .
        "üí≥ *Total a Pagar*: R$" . number_format($totalComDesconto, 2, ',', '.') . "\n\n" .
        "üìå *Forma de pagamento:*\n".
        "üîπ PIX: `1aebb1bd-10b7-435e-bd17-03adf4451088`\n\n" .
        "üì§ *Ap√≥s o pagamento, envie o comprovante para*: @Fraudarei\n\n" .
        "üì¶ *C√≥digo de rastreio do pedido:* `$codigoRastreio`\n" .
        "Use o comando /status seguido do c√≥digo para acompanhar seu pedido.";

    editMessage($chat_id, $message_id, $resumo);

    unset($usuarios[$chat_id]);
    file_put_contents($usuariosFile, json_encode($usuarios));
}
?>